{
    "search": [
        {
            "name": "extract-search-params",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "search-beckn-request.jsonata",
                "outputKey": "graphqlVariables"
            }
        },
        {
            "name": "send-search-graphql-request",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "search.graphql",
                "variablesKey": "graphqlVariables",
                "outputKey": "graphqlResponse"
            }
        },
        {
            "name": "generate-beckn-response",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "on-search-beckn-response.jsonata",
                "outputKey": "becknResponse"
            }
        }
    ],
    "select": [
        {
            "name": "extract-transaction-id",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "extract-transaction-id-from-beckn.jsonata",
                "outputKey": "becknTransactionId",
                "common": "true"
            }
        },
        {
            "name": "get-existing-beckn-transaction",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "getBecknTransaction.graphql",
                "variablesKey": "becknTransactionId",
                "outputDataPath": "body.data.getBecknTransaction.vendureAuthToken",
                "outputKey": "vendureAuthToken"
            }
        },
        {
            "name": "set-existing-auth-token",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "check-if-vendure-auth-token-exists.jsonata",
                "outputKey": "usingExistingVendureAuthToken",
                "common": "true"
            }
        },
        {
            "name": "erase-existing-cart",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "removeAllOrderLines.graphql",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "removeAllOrderLinesResult",
                "outputDataPath": "body.data"
            },
            "condition": "context.usingExistingVendureAuthToken"
        },
        {
            "name": "extract-select-params",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "select-beckn-request.jsonata",
                "outputKey": "cartDetails"
            }
        },
        {
            "name": "add-first-item-to-order",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "addItemToOrder.graphql",
                "variablesKey": "cartDetails.firstItem",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "responseWithVendureAuthToken"
            }
        },
        {
            "name": "extract-vendure-auth-token",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "extract-vendure-auth-token-from-graphql-response.jsonata",
                "outputKey": "vendureAuthToken",
                "common": "true"
            },
            "condition": "!context.usingExistingVendureAuthToken"
        },
        {
            "name": "add-remaining-items-to-order",
            "type": "send-multiple-graphql-requests",
            "args": {
                "graphqlFilename": "addItemToOrder.graphql",
                "variablesKey": "cartDetails.restItems",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "addRestItemsToOrderResponse"
            },
            "condition": "context.cartDetails.totalItems > 1"
        },
        {
            "name": "form-beckn-transaction-variables",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "form-beckn-transaction-variables.jsonata",
                "common": "true",
                "outputKey": "addBecknTransactionVariables"
            },
            "condition": "!context.usingExistingVendureAuthToken"
        },
        {
            "name": "add-beckn-transaction",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "addBecknTransaction.graphql",
                "variablesKey": "addBecknTransactionVariables",
                "outputKey": "addBecknTransactionOutput"
            },
            "condition": "!context.usingExistingVendureAuthToken"
        },
        {
            "name": "get-current-order",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "activeOrderOnSelect.graphql",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "currentOrderResponse"
            }
        },
        {
            "name": "get-eligible-shipping-methods",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "eligibleShippingMethods.graphql",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "eligibleShippingMethods",
                "outputDataPath": "body.data.eligibleShippingMethods"
            }
        },
        {
            "name": "generate-beckn-response",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "on-select-beckn-response.jsonata",
                "outputKey": "becknResponse"
            }
        }
    ],
    "init": [
        {
            "name": "extract-order-id",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "extract-order-id-from-beckn.jsonata",
                "outputKey": "existingOrderId",
                "common": "true"
            },
            "condition": "context.becknRequest.body?.message?.order?.id"
        },
        {
            "name": "get-existing-beckn-transaction-from-orderId",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "getBecknTransactionFromOrderId.graphql",
                "variablesKey": "existingOrderId",
                "outputDataPath": "body.data.getBecknTransactionFromOrderId.vendureAuthToken",
                "outputKey": "vendureAuthToken"
            },
            "condition": "context.becknRequest.body?.message?.order?.id"
        },
        {
            "name": "extract-transaction-id",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "extract-transaction-id-from-beckn.jsonata",
                "outputKey": "becknTransactionId",
                "common": "true"
            },
            "condition": "!context.vendureAuthToken"
        },
        {
            "name": "get-existing-beckn-transaction",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "getBecknTransaction.graphql",
                "variablesKey": "becknTransactionId",
                "outputDataPath": "body.data.getBecknTransaction.vendureAuthToken",
                "outputKey": "vendureAuthToken"
            },
            "condition": "!context.vendureAuthToken"
        },
        {
            "name": "set-existing-auth-token",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "check-if-vendure-auth-token-exists.jsonata",
                "outputKey": "usingExistingVendureAuthToken",
                "common": "true"
            }
        },
        {
            "name": "erase-existing-cart",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "removeAllOrderLines.graphql",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "removeAllOrderLinesResult",
                "outputDataPath": "body.data"
            },
            "condition": "context.usingExistingVendureAuthToken"
        },
        {
            "name": "extract-init-params",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "init-beckn-request.jsonata",
                "outputKey": "cartDetails"
            }
        },
        {
            "name": "add-first-item-to-order",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "addItemToOrder.graphql",
                "variablesKey": "cartDetails.firstItem",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "responseWithVendureAuthToken"
            }
        },
        {
            "name": "extract-vendure-auth-token",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "extract-vendure-auth-token-from-graphql-response.jsonata",
                "outputKey": "vendureAuthToken",
                "common": "true"
            },
            "condition": "!context.usingExistingVendureAuthToken"
        },
        {
            "name": "add-remaining-items-to-order",
            "type": "send-multiple-graphql-requests",
            "args": {
                "graphqlFilename": "addItemToOrder.graphql",
                "variablesKey": "cartDetails.restItems",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "addRestItemsToOrderResponse"
            },
            "condition": "context.cartDetails.totalItems > 1"
        },
        {
            "name": "form-beckn-transaction-variables",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "form-beckn-transaction-variables.jsonata",
                "common": "true",
                "outputKey": "addBecknTransactionVariables"
            },
            "condition": "!context.usingExistingVendureAuthToken"
        },
        {
            "name": "add-beckn-transaction",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "addBecknTransaction.graphql",
                "variablesKey": "addBecknTransactionVariables",
                "outputKey": "addBecknTransactionOutput"
            },
            "condition": "!context.usingExistingVendureAuthToken"
        },
        {
            "name": "get-eligible-shipping-methods",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "eligibleShippingMethods.graphql",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "eligibleShippingMethods",
                "outputDataPath": "body.data.eligibleShippingMethods"
            }
        },
        {
            "name": "get-shipping-method-id",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "shipping-method-code-to-id.jsonata",
                "common": "true",
                "outputKey": "setOrderShippingMethodInput"
            }
        },
        {
            "name": "set-order-shipping-method",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "setOrderShippingMethod.graphql",
                "authTokenKey": "vendureAuthToken",
                "variablesKey": "setOrderShippingMethodInput",
                "outputKey": "setOrderShippingMethodResult",
                "outputDataPath": "body.data"
            }
        },
        {
            "name": "set-customer-for-order",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "setCustomerForOrder.graphql",
                "authTokenKey": "vendureAuthToken",
                "variablesKey": "cartDetails.setCustomerForOrderInput",
                "outputKey": "setCustomerForOrderResult",
                "outputDataPath": "body.data"
            }
        },
        {
            "name": "set-order-shipping-address",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "setOrderShippingAddress.graphql",
                "authTokenKey": "vendureAuthToken",
                "variablesKey": "cartDetails.setOrderShippingAddressInput",
                "outputKey": "setOrderShippingAddressResult",
                "outputDataPath": "body.data"
            }
        },
        {
            "name": "set-order-billing-address",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "setOrderBillingAddress.graphql",
                "authTokenKey": "vendureAuthToken",
                "variablesKey": "cartDetails.setOrderBillingAddressInput",
                "outputKey": "setOrderBillingAddressResult",
                "outputDataPath": "body.data"
            }
        },
        {
            "name": "get-eligible-payment-methods",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "eligiblePaymentMethods.graphql",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "eligiblePaymentMethods",
                "outputDataPath": "body.data.eligiblePaymentMethods"
            }
        },
        {
            "name": "get-current-order",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "activeOrderOnInit.graphql",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "currentOrderResponse",
                "outputDataPath": "body.data"
            }
        },
        {
            "name": "generate-beckn-response",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "on-init-beckn-response.jsonata",
                "outputKey": "becknResponse"
            }
        }
    ],
    "confirm": [
        {
            "name": "extract-order-id",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "extract-order-id-from-beckn.jsonata",
                "outputKey": "existingOrderId",
                "common": "true"
            },
            "condition": "context.becknRequest.body?.message?.order?.id"
        },
        {
            "name": "get-existing-beckn-transaction-from-orderId",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "getBecknTransactionFromOrderId.graphql",
                "variablesKey": "existingOrderId",
                "outputDataPath": "body.data.getBecknTransactionFromOrderId.vendureAuthToken",
                "outputKey": "vendureAuthToken"
            },
            "condition": "context.becknRequest.body?.message?.order?.id"
        },
        {
            "name": "extract-transaction-id",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "extract-transaction-id-from-beckn.jsonata",
                "outputKey": "becknTransactionId",
                "common": "true"
            },
            "condition": "!context.vendureAuthToken"
        },
        {
            "name": "get-existing-beckn-transaction",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "getBecknTransaction.graphql",
                "variablesKey": "becknTransactionId",
                "outputDataPath": "body.data.getBecknTransaction.vendureAuthToken",
                "outputKey": "vendureAuthToken"
            },
            "condition": "!context.vendureAuthToken"
        },
        {
            "name": "set-existing-auth-token",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "check-if-vendure-auth-token-exists.jsonata",
                "outputKey": "usingExistingVendureAuthToken",
                "common": "true"
            }
        },
        {
            "name": "get-order-initial",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "activeOrderOnInit.graphql",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "orderInitialState",
                "outputDataPath": "body.data.activeOrder"
            }
        },
        {
            "name": "check-if-order-can-be-modified",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "check-if-order-can-be-modified.jsonata",
                "outputKey": "orderCanBeModified",
                "common": "true"
            }
        },
        {
            "name": "erase-existing-cart",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "removeAllOrderLines.graphql",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "removeAllOrderLinesResult",
                "outputDataPath": "body.data"
            },
            "condition": "context.orderCanBeModified"
        },
        {
            "name": "extract-confirm-params",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "confirm-beckn-request.jsonata",
                "outputKey": "cartDetails"
            }
        },
        {
            "name": "add-first-item-to-order",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "addItemToOrder.graphql",
                "variablesKey": "cartDetails.firstItem",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "responseWithVendureAuthToken"
            },
            "condition": "context.orderCanBeModified"
        },
        {
            "name": "extract-vendure-auth-token",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "extract-vendure-auth-token-from-graphql-response.jsonata",
                "outputKey": "vendureAuthToken",
                "common": "true"
            },
            "condition": "!context.usingExistingVendureAuthToken"
        },
        {
            "name": "add-remaining-items-to-order",
            "type": "send-multiple-graphql-requests",
            "args": {
                "graphqlFilename": "addItemToOrder.graphql",
                "variablesKey": "cartDetails.restItems",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "addRestItemsToOrderResponse"
            },
            "condition": "context.orderCanBeModified && context.cartDetails.totalItems > 1"
        },
        {
            "name": "form-beckn-transaction-variables",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "form-beckn-transaction-variables.jsonata",
                "common": "true",
                "outputKey": "addBecknTransactionVariables"
            },
            "condition": "!context.usingExistingVendureAuthToken"
        },
        {
            "name": "add-beckn-transaction",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "addBecknTransaction.graphql",
                "variablesKey": "addBecknTransactionVariables",
                "outputKey": "addBecknTransactionOutput"
            },
            "condition": "!context.usingExistingVendureAuthToken"
        },
        {
            "name": "get-eligible-shipping-methods",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "eligibleShippingMethods.graphql",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "eligibleShippingMethods",
                "outputDataPath": "body.data.eligibleShippingMethods"
            }
        },
        {
            "name": "get-shipping-method-id",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "shipping-method-code-to-id.jsonata",
                "common": "true",
                "outputKey": "setOrderShippingMethodInput"
            }
        },
        {
            "name": "set-order-shipping-method",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "setOrderShippingMethod.graphql",
                "authTokenKey": "vendureAuthToken",
                "variablesKey": "setOrderShippingMethodInput",
                "outputKey": "setOrderShippingMethodResult",
                "outputDataPath": "body.data"
            },
            "condition": "context.orderCanBeModified"
        },
        {
            "name": "set-customer-for-order",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "setCustomerForOrder.graphql",
                "authTokenKey": "vendureAuthToken",
                "variablesKey": "cartDetails.setCustomerForOrderInput",
                "outputKey": "setCustomerForOrderResult",
                "outputDataPath": "body.data"
            },
            "condition": "context.orderCanBeModified"
        },
        {
            "name": "set-order-shipping-address",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "setOrderShippingAddress.graphql",
                "authTokenKey": "vendureAuthToken",
                "variablesKey": "cartDetails.setOrderShippingAddressInput",
                "outputKey": "setOrderShippingAddressResult",
                "outputDataPath": "body.data"
            },
            "condition": "context.orderCanBeModified"
        },
        {
            "name": "set-order-billing-address",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "setOrderBillingAddress.graphql",
                "authTokenKey": "vendureAuthToken",
                "variablesKey": "cartDetails.setOrderBillingAddressInput",
                "outputKey": "setOrderBillingAddressResult",
                "outputDataPath": "body.data"
            },
            "condition": "context.orderCanBeModified"
        },
        {
            "name": "get-eligible-payment-methods",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "eligiblePaymentMethods.graphql",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "eligiblePaymentMethods",
                "outputDataPath": "body.data.eligiblePaymentMethods"
            }
        },
        {
            "name": "form-payment-details-input",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "form-payment-details-input.jsonata",
                "outputKey": "setPaymentDetailsInput",
                "common": "true"
            }
        },
        {
            "name": "set-payment-details-input",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "setOrderCustomFields.graphql",
                "authTokenKey": "vendureAuthToken",
                "variablesKey": "setPaymentDetailsInput",
                "outputKey": "setPaymentDetailsOutput",
                "outputDataPath": "body.data"
            }
        },
        {
            "name": "get-current-order",
            "type": "send-graphql-request",
            "args": {
                "graphqlFilename": "activeOrderOnConfirm.graphql",
                "authTokenKey": "vendureAuthToken",
                "outputKey": "currentOrderResponse",
                "outputDataPath": "body.data"
            }
        },
        {
            "name": "generate-beckn-response",
            "type": "transform-and-add",
            "args": {
                "jsonataFilename": "on-confirm-beckn-response.jsonata",
                "outputKey": "becknResponse"
            }
        }
    ]
}
